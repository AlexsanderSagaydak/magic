<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>My Profile</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        'dark-secondary': '#1e293b',
                        'dark-tertiary': '#334155',
                        accent: '#3b82f6',
                    }
                }
            }
        };
    </script>

    <script src="/js/app.js"></script>

    <style>
        .edit-field { display: none; }
        .view-field { display: block; }

        .edit-mode .edit-field { display: block; }
        .edit-mode .view-field { display: none; }

        .edit-mode .edit-buttons-center {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
        }

        /* Editable fields highlight */
        .edit-mode input[type="text"],
        .edit-mode input[type="date"],
        .edit-mode input[type="time"],
        .edit-mode textarea {
            animation: highlightField 0.3s ease-in-out;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5), 0 0 8px rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6) !important;
            transition: all 0.2s ease;
        }

        .edit-mode input[type="text"]:focus,
        .edit-mode input[type="date"]:focus,
        .edit-mode input[type="time"]:focus,
        .edit-mode textarea:focus {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.7), 0 0 12px rgba(255, 255, 255, 0.5);
            border-color: rgba(255, 255, 255, 0.8) !important;
        }

        @keyframes highlightField {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.8), 0 0 16px rgba(255, 255, 255, 0.6);
            }
            100% {
                box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5), 0 0 8px rgba(255, 255, 255, 0.3);
            }
        }

        /* Accordion styles */
        .accordion-content,
        .accordion-subcontent {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        .accordion-content.expanded {
            max-height: 3000px;
            opacity: 1;
            margin-top: 0.5rem;
        }

        .accordion-subcontent.expanded {
            max-height: 1000px;
            opacity: 1;
            margin-top: 0.5rem;
            padding-left: 0.75rem;
        }

        .accordion-content.collapsed,
        .accordion-subcontent.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .chevron {
            transition: transform 0.3s ease;
        }

        .chevron.rotate-180 {
            transform: rotate(180deg);
        }

        /* Checkbox styles */
        .skill-checkbox {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .skill-checkbox:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* Hide scrollbars */
        section::-webkit-scrollbar,
        aside::-webkit-scrollbar {
            display: none;
        }

        section,
        aside {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>

<body class="h-screen overflow-hidden bg-dark text-gray-100 font-sans antialiased flex flex-col">

<!-- NAVIGATION -->
<div th:replace="~{fragments::header}"></div>

<!-- MAIN CONTENT -->
<main class="flex-1 flex bg-gradient-to-b from-dark via-dark-secondary to-dark overflow-hidden mt-16">
    <div class="w-full max-w-7xl mx-auto flex gap-3 px-4 pt-6 pb-12">

        <!-- LEFT SIDEBAR -->
        <div class="w-full lg:w-64 flex-shrink-0 overflow-y-auto">
            <div th:replace="~{fragments::sidebar}"></div>
        </div>

        <!-- PROFILE CONTENT (scrollable center) -->
        <section class="flex-1 overflow-y-auto px-1">

            <!-- PROFILE CARD -->
            <div id="profileCard" class="bg-dark-secondary border border-dark-tertiary rounded-xl overflow-hidden p-8">

                <!-- HEADER TOP: AVATAR -->
                <div class="relative flex items-start gap-6 mb-6 pb-6 border-b border-dark-tertiary">

                    <div class="relative">
                        <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-accent bg-dark-tertiary">
                            <img th:src="${user.avatarUrl != null ? user.avatarUrl : '/images/default-avatar.svg'}"
                                 id="profileAvatarRegular"
                                 class="w-full h-full object-cover"
                                 onerror="this.src='/images/default-avatar.svg'">
                        </div>
                        <button onclick="openAvatarUpload()"
                                class="absolute bottom-0 right-0 bg-accent hover:bg-blue-600 p-2 rounded-full border-2 border-dark transition">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                    </div>

                    <div class="flex-1 pt-2">
                        <!-- ACCOUNT STATUS -->
                        <div class="mb-3 flex items-center gap-2">
                            <span class="text-gray-400 text-sm">Account Status:</span>
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span class="text-gray-100 text-sm">Active</span>
                        </div>

                        <h2 class="text-3xl font-bold mb-2">
                            <span th:text="${user.firstName}"></span>
                            <span th:text="${user.lastName}"></span>
                        </h2>

                        <p class="text-gray-400 text-lg mb-4">
                            @<span th:text="${user.username}"></span>
                        </p>

                        <!-- SPECIALIZATION -->
                        <div class="flex items-center gap-2 view-field">
                            <span class="text-gray-400 text-sm">Специалист:</span>
                            <span class="text-gray-100 text-sm" th:text="${user.specialization != null && !user.specialization.isEmpty() ? user.specialization : 'Не указано'}"></span>
                        </div>
                        <div class="edit-field">
                            <label class="text-gray-400 text-sm mb-1 block">Специалист</label>
                            <input type="text" name="specialization" th:value="${user.specialization}"
                                   class="w-full max-w-md px-3 py-2 bg-dark-tertiary rounded border border-dark-tertiary text-gray-100 focus:border-accent focus:outline-none"
                                   placeholder="Укажите вашу специализацию">
                        </div>
                    </div>

                    <!-- EDIT BUTTON (bottom right corner) -->
                    <button onclick="toggleEditMode()"
                            class="view-field absolute bottom-2 right-2 p-2 rounded-lg hover:bg-dark-tertiary transition"
                            title="Edit Profile">
                        <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </button>

                </div>

                <!-- EDIT MODE BUTTONS (centered under header) -->
                <div class="edit-field edit-buttons-center mb-6">
                    <button type="submit" form="profileFormRegular"
                            class="px-8 py-2 rounded-full bg-accent hover:bg-blue-500 text-white font-semibold shadow-md hover:shadow-lg transition-all duration-200">
                        Save Changes
                    </button>
                    <button type="button" onclick="toggleEditMode()"
                            class="px-8 py-2 rounded-full bg-transparent border-2 border-accent text-accent hover:bg-accent hover:text-white font-semibold transition-all duration-200">
                        Cancel
                    </button>
                </div>

                <!-- ============================= -->
                <!-- FORM START -->
                <!-- ============================= -->
                <form id="profileFormRegular" method="post" th:action="@{/users/profile/save}" class="space-y-10">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!-- О СЕБЕ -->
                    <div class="mb-8">
                        <h3 class="text-sm mb-3 text-gray-400">О себе</h3>
                        <hr class="border-dark-tertiary mb-3">

                        <div class="view-field">
                            <p class="text-gray-100" th:text="${user.aboutMe != null && !user.aboutMe.isEmpty() ? user.aboutMe : 'Не указано'}"></p>
                        </div>

                        <div class="edit-field">
                            <textarea name="aboutMe" id="aboutMeFieldRegular" maxlength="200"
                                      th:text="${user.aboutMe}"
                                      class="w-full px-4 py-3 bg-dark-tertiary border border-dark-tertiary rounded-lg text-gray-100 focus:border-accent focus:ring-accent resize-none"
                                      rows="3"
                                      placeholder="Расскажите немного о себе..."></textarea>
                            <div class="flex justify-end mt-1">
                                <span id="charCountRegular" class="text-xs text-gray-500">0 / 200</span>
                            </div>
                        </div>
                    </div>

                    <!-- PROFILE INFORMATION -->
                    <div class="mb-8">
                        <h3 class="text-sm mb-3 text-gray-400">Profile Information</h3>
                        <hr class="border-dark-tertiary mb-3">

                        <div class="space-y-3">
                            <div class="flex items-center gap-4">
                                <span class="text-gray-400 text-sm w-28 flex-shrink-0">First Name:</span>
                                <span class="text-gray-100 view-field" th:text="${user.firstName}"></span>
                                <div class="edit-field flex-1">
                                    <input type="text" name="firstName" th:value="${user.firstName}"
                                           class="w-full max-w-md px-3 py-2 bg-dark-tertiary rounded border border-dark-tertiary text-gray-100 focus:border-accent focus:outline-none">
                                </div>
                            </div>

                            <div class="flex items-center gap-4">
                                <span class="text-gray-400 text-sm w-28 flex-shrink-0">Last Name:</span>
                                <span class="text-gray-100 view-field" th:text="${user.lastName}"></span>
                                <div class="edit-field flex-1">
                                    <input type="text" name="lastName" th:value="${user.lastName}"
                                           class="w-full max-w-md px-3 py-2 bg-dark-tertiary rounded border border-dark-tertiary text-gray-100 focus:border-accent focus:outline-none">
                                </div>
                            </div>

                            <div class="flex items-center gap-4">
                                <span class="text-gray-400 text-sm w-28 flex-shrink-0">Email:</span>
                                <span class="text-gray-100 break-all" th:text="${user.email}"></span>
                            </div>

                            <div class="flex items-center gap-4">
                                <span class="text-gray-400 text-sm w-28 flex-shrink-0">Username:</span>
                                <span class="text-gray-100" th:text="${user.username}"></span>
                            </div>

                            <div th:if="${user.regularProfile != null}" class="flex items-center gap-4">
                                <span class="text-gray-400 text-sm w-28 flex-shrink-0">Birth Date:</span>
                                <span class="text-gray-100 view-field"
                                      th:text="${user.regularProfile.birthDate != null ? #temporals.format(user.regularProfile.birthDate, 'dd MMM yyyy') : 'Not set'}"></span>
                                <div class="edit-field flex-1">
                                    <input type="date" name="birthDate" th:value="${user.regularProfile.birthDate}"
                                           class="w-full max-w-md px-3 py-2 bg-dark-tertiary rounded border border-dark-tertiary text-gray-100 focus:border-accent focus:outline-none">
                                </div>
                            </div>

                            <div th:if="${user.regularProfile != null}" class="flex items-center gap-4">
                                <span class="text-gray-400 text-sm w-28 flex-shrink-0">Birth Place:</span>
                                <span class="text-gray-100 view-field"
                                      th:text="${user.regularProfile.birthPlace != null ? user.regularProfile.birthPlace : 'Not set'}"></span>
                                <div class="edit-field flex-1">
                                    <input type="text" name="birthPlace" th:value="${user.regularProfile.birthPlace}"
                                           class="w-full max-w-md px-3 py-2 bg-dark-tertiary rounded border border-dark-tertiary text-gray-100 focus:border-accent focus:outline-none"
                                           placeholder="Enter birth place">
                                </div>
                            </div>

                            <div th:if="${user.regularProfile != null}" class="flex items-center gap-4">
                                <span class="text-gray-400 text-sm w-28 flex-shrink-0">Birth Time:</span>
                                <span class="text-gray-100 view-field"
                                      th:text="${user.regularProfile.birthTime != null ? #temporals.format(user.regularProfile.birthTime, 'HH:mm') : 'Not set'}"></span>
                                <div class="edit-field flex-1">
                                    <input type="time" name="birthTime" th:value="${user.regularProfile.birthTime}"
                                           class="w-full max-w-md px-3 py-2 bg-dark-tertiary rounded border border-dark-tertiary text-gray-100 focus:border-accent focus:outline-none">
                                </div>
                            </div>
                        </div>
                    </div>

                </form>

            </div>

        </section>

        <!-- RIGHT SIDEBAR - Empty spacer to maintain consistent width with wizard profile -->
        <aside class="w-full lg:w-80 lg:min-w-80 flex-shrink-0 overflow-y-auto">
        </aside>

    </div>
</main>

<script>
    function toggleEditMode() {
        const card = document.getElementById('profileCard');
        card.classList.toggle('edit-mode');
    }

    /**
     * Toggles accordion section open/closed
     */
    function toggleAccordion(button) {
        const content = button.nextElementSibling;
        const chevron = button.querySelector('.chevron');

        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            chevron.classList.add('rotate-180');
        } else {
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            chevron.classList.remove('rotate-180');
        }
    }

    /**
     * Load wizard skills from backend
     */
    async function loadWizardSkills() {
        try {
            const response = await fetch('/api/wizard/skills');

            if (!response.ok) {
                console.error(`Failed to load skills: ${response.status}`);
                return;
            }

            const data = await response.json();

            if (!data.skills) {
                console.log('No skills data returned');
                return;
            }

            const skills = data.skills;

            // Apply section1 (with subsections)
            if (skills.section1) {
                Object.entries(skills.section1).forEach(([subsection, skillList]) => {
                    if (Array.isArray(skillList)) {
                        skillList.forEach(skillName => {
                            const checkbox = document.querySelector(
                                `input[data-subsection="${subsection}"][value="${skillName}"]`
                            );
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                });
            }

            // Apply sections 2-7 (flat lists)
            ['section2', 'section3', 'section4', 'section5', 'section7'].forEach(section => {
                if (skills[section] && Array.isArray(skills[section])) {
                    skills[section].forEach(skillName => {
                        const checkbox = document.querySelector(
                            `input[data-section="${section}"][value="${skillName}"]`
                        );
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            });

            console.log('Skills loaded successfully');

        } catch (error) {
            console.error('Error loading wizard skills:', error);
        }
    }

    /**
     * Save wizard skills to backend
     */
    async function saveWizardSkills() {
        const skills = {
            section1: {
                subsection1_1: [],
                subsection1_2: [],
                subsection1_3: [],
                subsection1_4: [],
                subsection1_5: []
            },
            section2: [],
            section3: [],
            section4: [],
            section5: [],
            section7: []
        };

        // Collect Section 1 (with subsections)
        ['subsection1_1', 'subsection1_2', 'subsection1_3', 'subsection1_4', 'subsection1_5'].forEach(subsection => {
            const checkboxes = document.querySelectorAll(`input[data-subsection="${subsection}"]:checked`);
            skills.section1[subsection] = Array.from(checkboxes).map(cb => cb.value);
        });

        // Collect Sections 2-7
        ['section2', 'section3', 'section4', 'section5', 'section7'].forEach(section => {
            const checkboxes = document.querySelectorAll(`input[data-section="${section}"]:checked`);
            skills[section] = Array.from(checkboxes).map(cb => cb.value);
        });

        // Get CSRF token
        const csrfToken = document.querySelector('input[name="_csrf"]')?.value;

        if (!csrfToken) {
            console.error('CSRF token not found');
            showToast('Ошибка: CSRF token не найден', 'error');
            return;
        }

        try {
            const response = await fetch('/api/wizard/skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: JSON.stringify({ skills })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                showToast('Навыки сохранены!', 'success');
                console.log('Skills saved successfully');

                // Reload page after 500ms to show updated skills
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                throw new Error(data.message || 'Failed to save');
            }

        } catch (error) {
            console.error('Error saving wizard skills:', error);
            showToast('Ошибка сохранения навыков', 'error');
        }
    }

    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', () => {
        const tabButtons = document.querySelectorAll('.tab-btn');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');

                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                // Remove active styles from all buttons
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-accent', 'text-accent');
                    btn.classList.add('border-transparent', 'text-gray-400');
                });

                // Show selected tab content
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');

                // Add active styles to clicked button
                button.classList.remove('border-transparent', 'text-gray-400');
                button.classList.add('border-accent', 'text-accent');
            });
        });

        // Load skills on page load (only for wizards)
        const accordion = document.querySelector('.wizard-skills-accordion');
        if (accordion) {
            loadWizardSkills();
        }

        // Character counter for About Me field
        const aboutMeField = document.getElementById('aboutMeFieldRegular');
        const charCount = document.getElementById('charCountRegular');

        if (aboutMeField && charCount) {
            // Update counter on page load
            updateCharCount();

            // Update counter on input
            aboutMeField.addEventListener('input', updateCharCount);

            function updateCharCount() {
                const length = aboutMeField.value.length;
                charCount.textContent = `${length} / 200`;

                // Change color based on remaining characters
                if (length > 180) {
                    charCount.classList.add('text-yellow-500');
                    charCount.classList.remove('text-gray-500');
                } else {
                    charCount.classList.add('text-gray-500');
                    charCount.classList.remove('text-yellow-500');
                }
            }
        }
    });

    // Image Modal Functions
    function openImageModal(imageSrc) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageSrc;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Post Management Functions
    function createPost() {
        const content = document.getElementById('postContent').value.trim();
        const imageUrl = document.getElementById('postImageUrl').value.trim();

        if (!content) {
            alert('Please enter some content');
            return;
        }

        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        const payload = { content: content };
        if (imageUrl) {
            payload.imageUrl = imageUrl;
        }

        fetch('/posts/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert(result.message || 'Error creating post');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating post');
        });
    }

    function deletePost(button) {
        if (!confirm('Are you sure you want to delete this post?')) {
            return;
        }

        const postId = button.getAttribute('data-post-id');
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch(`/posts/${postId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                [header]: token
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert(result.message || 'Error deleting post');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting post');
        });
    }

    // ========== AVATAR UPLOAD FUNCTIONALITY ==========
    let cropper = null;
    let selectedAvatarFile = null;

    function openAvatarUpload() {
        document.getElementById('avatarModal').classList.remove('hidden');
    }

    function closeAvatarUpload() {
        document.getElementById('avatarModal').classList.add('hidden');
        resetAvatarCrop();
    }

    function handleAvatarSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('Invalid file format. Please use JPEG, PNG, or WebP');
            return;
        }

        // Validate file size (5MB)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('File is too large. Maximum size is 5MB');
            return;
        }

        selectedAvatarFile = file;

        // Show crop area
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.getElementById('avatarCropImage');
            img.src = e.target.result;

            document.getElementById('avatarUploadArea').classList.add('hidden');
            document.getElementById('avatarCropArea').classList.remove('hidden');

            // Initialize Cropper.js
            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(img, {
                aspectRatio: 1, // Square
                viewMode: 2,
                dragMode: 'move',
                autoCropArea: 1,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
            });
        };
        reader.readAsDataURL(file);
    }

    function rotateAvatar(degree) {
        if (cropper) {
            cropper.rotate(degree);
        }
    }

    function resetAvatarCrop() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        document.getElementById('avatarInput').value = '';
        document.getElementById('avatarUploadArea').classList.remove('hidden');
        document.getElementById('avatarCropArea').classList.add('hidden');
        selectedAvatarFile = null;
    }

    function cancelAvatarUpload() {
        resetAvatarCrop();
        closeAvatarUpload();
    }

    async function uploadAvatar() {
        if (!cropper) return;

        // Get cropped canvas (400x400 for avatar)
        const canvas = cropper.getCroppedCanvas({
            width: 400,
            height: 400,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });

        // Convert to blob
        canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('avatar', blob, 'avatar.jpg');

            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            try {
                const response = await fetch('/api/users/avatar', {
                    method: 'POST',
                    headers: {
                        [header]: token
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update avatar image
                    document.getElementById('profileAvatarRegular').src = result.avatarUrl + '?t=' + Date.now();
                    showToast('Avatar updated successfully!', 'success');
                    closeAvatarUpload();
                } else {
                    alert(result.message || 'Failed to upload avatar');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to upload avatar');
            }
        }, 'image/jpeg', 0.9);
    }

    // Drag & drop support
    const dropZone = document.getElementById('avatarDropZone');
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-accent');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-accent');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-accent');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('avatarInput').files = files;
                handleAvatarSelect({ target: { files: files } });
            }
        });
    }
</script>

<!-- Image Modal -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 items-center justify-center" onclick="closeImageModal()">
    <div class="relative max-w-7xl max-h-screen p-4">
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 text-4xl font-bold z-10">
            &times;
        </button>
        <img id="modalImage" src="" alt="Full size image" class="max-w-full max-h-screen object-contain rounded-lg">
    </div>
</div>

<!-- Avatar Upload Modal -->
<div id="avatarModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
    <div class="bg-dark-secondary rounded-xl max-w-2xl w-full mx-4 p-6 border border-dark-tertiary" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Upload Avatar</h3>
            <button onclick="closeAvatarUpload()" class="text-gray-400 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Upload Area -->
        <div id="avatarUploadArea" class="mb-4">
            <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/webp" class="hidden" onchange="handleAvatarSelect(event)">
            <div id="avatarDropZone" onclick="document.getElementById('avatarInput').click()"
                 class="border-2 border-dashed border-dark-tertiary rounded-lg p-8 text-center cursor-pointer hover:border-accent transition">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <p class="text-gray-300 mb-2">Click to upload or drag & drop</p>
                <p class="text-gray-500 text-sm">JPEG, PNG, WebP • Max 5MB • Square image recommended</p>
            </div>
        </div>

        <!-- Crop Area (hidden by default) -->
        <div id="avatarCropArea" class="hidden">
            <div class="mb-4" style="max-height: 400px;">
                <img id="avatarCropImage" src="" alt="Crop" style="max-width: 100%;">
            </div>

            <div class="flex items-center justify-between mb-4">
                <button onclick="rotateAvatar(-90)" class="px-3 py-2 bg-dark-tertiary hover:bg-dark rounded transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                    </svg>
                </button>
                <button onclick="rotateAvatar(90)" class="px-3 py-2 bg-dark-tertiary hover:bg-dark rounded transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"/>
                    </svg>
                </button>
                <button onclick="resetAvatarCrop()" class="px-4 py-2 bg-dark-tertiary hover:bg-dark rounded transition">
                    Reset
                </button>
            </div>

            <div class="flex gap-3">
                <button onclick="cancelAvatarUpload()" class="flex-1 px-4 py-2 bg-dark-tertiary hover:bg-dark rounded transition">
                    Cancel
                </button>
                <button onclick="uploadAvatar()" class="flex-1 px-4 py-2 bg-accent hover:bg-blue-600 rounded transition">
                    Upload Avatar
                </button>
            </div>
        </div>
    </div>
</div>

</body>
</html>
