<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing - Wizard</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        'dark-secondary': '#1e293b',
                        'dark-tertiary': '#334155',
                        accent: '#3b82f6',
                    }
                }
            }
        }
    </script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="/js/app.js"></script>
</head>

<body class="h-screen overflow-hidden bg-dark text-gray-100 font-sans antialiased flex flex-col">

<!-- NAVIGATION -->
<div th:replace="~{fragments::header}"></div>

<!-- MAIN CONTENT -->
<main class="flex-1 flex bg-gradient-to-b from-dark via-dark-secondary to-dark overflow-hidden mt-16">
    <div class="w-full max-w-7xl mx-auto flex gap-8 px-4 pt-6 pb-12">

        <!-- LEFT SIDEBAR -->
        <div class="w-full lg:w-64 flex-shrink-0 overflow-y-auto">
            <div th:replace="~{fragments::sidebar}"></div>
        </div>

        <!-- BILLING CONTENT -->
        <section class="flex-1 max-w-4xl overflow-y-auto px-4">

            <!-- TAB NAVIGATION -->
            <div class="mb-6 border-b border-dark-tertiary">
                <div class="flex gap-4">
                    <button class="tab-btn px-6 py-3 font-medium text-sm transition border-b-2 border-accent text-accent"
                            data-tab="servicePrice">
                        Service & Price
                    </button>
                    <button class="tab-btn px-6 py-3 font-medium text-sm transition border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                            data-tab="statistic">
                        Statistic
                    </button>
                    <button class="tab-btn px-6 py-3 font-medium text-sm transition border-b-2 border-transparent text-gray-400 hover:text-gray-300"
                            data-tab="bankDetails">
                        Bank Details
                    </button>
                </div>
            </div>

            <!-- TAB CONTENT -->
            <div id="tabContent">
                <div id="tab-servicePrice" class="tab-content">
                    <div th:replace="~{billing-fragments::servicePrice}"></div>
                </div>
                <div id="tab-statistic" class="tab-content hidden">
                    <div th:replace="~{billing-fragments::statistic}"></div>
                </div>
                <div id="tab-bankDetails" class="tab-content hidden">
                    <div th:replace="~{billing-fragments::bankDetails}"></div>
                </div>
            </div>

        </section>

    </div>
</main>

<script>
    // Toggle chat price input based on free checkbox
    function toggleChatPrice() {
        const checkbox = document.getElementById('chatFreeCheckbox');
        const priceInput = document.getElementById('chatPriceInput');
        const priceLabel = document.getElementById('chatPriceLabel');

        if (checkbox.checked) {
            // Бесплатно - скрываем input и label
            priceInput.classList.add('hidden');
            priceLabel.classList.add('hidden');
            priceInput.value = '';
        } else {
            // Не бесплатно - показываем input и label
            priceInput.classList.remove('hidden');
            priceLabel.classList.remove('hidden');
        }
    }

    // Toggle feed price input based on free checkbox
    function toggleFeedPrice() {
        const checkbox = document.getElementById('feedFreeCheckbox');
        const priceInput = document.getElementById('feedPriceInput');
        const priceLabel = document.getElementById('feedPriceLabel');

        if (checkbox.checked) {
            // Бесплатно - скрываем input и label
            priceInput.classList.add('hidden');
            priceLabel.classList.add('hidden');
            priceInput.value = '';
        } else {
            // Не бесплатно - показываем input и label
            priceInput.classList.remove('hidden');
            priceLabel.classList.remove('hidden');
        }
    }

    // Statistics section management
    let currentStatSection = null;

    function toggleStatSection(type) {
        const section = document.getElementById('statSection');
        const title = document.getElementById('statSectionTitle');
        const usersList = document.getElementById('statUsersList');

        const titles = {
            'likes': 'Пользователи которые лайкнули',
            'favorites': 'Пользователи добавившие в избранное',
            'subscribers': 'Подписчики',
            'views': 'Пользователи просмотревшие профиль'
        };

        if (currentStatSection === type && !section.classList.contains('hidden')) {
            // Close if clicking the same section
            section.classList.add('hidden');
            currentStatSection = null;
        } else {
            // Open new section
            title.textContent = titles[type];
            section.classList.remove('hidden');
            currentStatSection = type;

            // Load users for this section (placeholder for now)
            loadStatUsers(type);
        }
    }

    function closeStatSection() {
        const section = document.getElementById('statSection');
        section.classList.add('hidden');
        currentStatSection = null;
    }

    function loadStatUsers(type) {
        const usersList = document.getElementById('statUsersList');

        // Show loading state
        usersList.innerHTML = '<p class="text-gray-400 text-sm">Загрузка...</p>';

        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        if (type === 'favorites') {
            fetch('/billing/statistics/favorites', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success && result.users && result.users.length > 0) {
                    usersList.innerHTML = result.users.map(user => `
                        <div class="flex items-center gap-3 p-3 bg-dark-secondary rounded hover:bg-dark-tertiary transition">
                            <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold">
                                ${user.firstName ? user.firstName.charAt(0) : user.username.charAt(0)}
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-200">${user.firstName || ''} ${user.lastName || ''} (@${user.username})</p>
                                <p class="text-xs text-gray-400">${formatDate(user.addedAt)}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    usersList.innerHTML = '<p class="text-gray-400 text-sm">Нет данных для отображения</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                usersList.innerHTML = '<p class="text-red-400 text-sm">Ошибка загрузки данных</p>';
            });
        } else if (type === 'subscribers') {
            fetch('/billing/statistics/subscribers', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success && result.users && result.users.length > 0) {
                    usersList.innerHTML = result.users.map(user => `
                        <div class="flex items-center gap-3 p-3 bg-dark-secondary rounded hover:bg-dark-tertiary transition">
                            <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold">
                                ${user.firstName ? user.firstName.charAt(0) : user.username.charAt(0)}
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-200">${user.firstName || ''} ${user.lastName || ''} (@${user.username})</p>
                                <p class="text-xs text-gray-400">${formatDate(user.subscribedAt)}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    usersList.innerHTML = '<p class="text-gray-400 text-sm">Нет данных для отображения</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                usersList.innerHTML = '<p class="text-red-400 text-sm">Ошибка загрузки данных</p>';
            });
        } else {
            // Placeholder for other statistics types
            usersList.innerHTML = '<p class="text-gray-400 text-sm">Нет данных для отображения</p>';
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 60) {
            return diffMins === 1 ? '1 минуту назад' : `${diffMins} минут назад`;
        } else if (diffHours < 24) {
            return diffHours === 1 ? '1 час назад' : `${diffHours} часов назад`;
        } else if (diffDays < 7) {
            return diffDays === 1 ? '1 день назад' : `${diffDays} дней назад`;
        } else {
            return date.toLocaleDateString('ru-RU');
        }
    }

    // Tab switching functionality
    document.addEventListener('DOMContentLoaded', () => {
        const tabButtons = document.querySelectorAll('.tab-btn');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.getAttribute('data-tab');

                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                // Remove active styles from all buttons
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-accent', 'text-accent');
                    btn.classList.add('border-transparent', 'text-gray-400');
                });

                // Show selected tab content
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');

                // Add active styles to clicked button
                button.classList.remove('border-transparent', 'text-gray-400');
                button.classList.add('border-accent', 'text-accent');
            });
        });
    });

    // Service management functions
    function addServiceRow() {
        const servicesList = document.getElementById('servicesList');
        const newRow = document.createElement('div');
        newRow.className = 'service-row flex items-center gap-3 py-2';
        newRow.innerHTML = `
            <input type="text"
                   class="flex-1 bg-dark border border-dark-tertiary rounded px-3 py-2 text-sm"
                   placeholder="Service name">
            <span class="text-sm text-gray-400">Price:</span>
            <input type="number"
                   class="w-24 bg-dark border border-dark-tertiary rounded px-3 py-2 text-sm"
                   placeholder="0.00">
            <button onclick="saveService(this)"
                    class="px-4 py-2 bg-accent hover:bg-blue-600 text-sm rounded transition">
                Save
            </button>
            <button onclick="cancelService(this)"
                    class="px-4 py-2 bg-dark-tertiary hover:bg-dark text-sm rounded transition">
                Cancel
            </button>
            <input type="hidden" class="service-id" value="">
        `;
        servicesList.appendChild(newRow);
    }

    // Attach delete button event listeners
    document.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const serviceId = e.target.getAttribute('data-service-id');
                deleteService(serviceId);
            }
        });
    });

    function editService(button) {
        const row = button.closest('.service-row');
        const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
        inputs.forEach(input => input.disabled = false);

        const editBtn = row.querySelector('button:nth-of-type(1)');
        const saveBtn = row.querySelector('button:nth-of-type(2)');
        editBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
    }

    function saveService(button) {
        const row = button.closest('.service-row');
        const serviceName = row.querySelector('input[type="text"]').value;
        const price = row.querySelector('input[type="number"]').value;
        const serviceId = row.querySelector('.service-id').value;

        if (!serviceName || !price) {
            alert('Please fill in both service name and price');
            return;
        }

        const data = {
            id: serviceId || null,
            serviceName: serviceName,
            price: parseFloat(price)
        };

        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch('/billing/service/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('Error saving service');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving service');
        });
    }

    function cancelService(button) {
        const row = button.closest('.service-row');
        row.remove();
    }

    function deleteService(serviceId) {
        if (!confirm('Are you sure you want to delete this service?')) {
            return;
        }

        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        const headers = {
            'Content-Type': 'application/json'
        };
        headers[header] = token;

        fetch('/billing/service/delete/' + serviceId, {
            method: 'DELETE',
            headers: headers
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('Error deleting service');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting service');
        });
    }
</script>

</body>
</html>
